# 議事録: ローカルLLM RAGシステム設計レビュー・再設計

- **日時:** 2026年2月23日
- **形式:** 非同期テキストベースレビュー（Claude対話）
- **参加者:** プロジェクトオーナー、Claude（レビュアー）
- **成果物:** 再設計仕様書 v2（`redesign_spec_v2.md`）

---

## 1. 背景と目的

プロジェクトオーナーが作成した「ローカルLLM統合型 Multi-Tool RAGシステム 設計仕様書」v1について、ハッカー視点での批判的レビューと改善提案を求めるところから本セッションは開始された。

---

## 2. レビューフェーズ: v1仕様書に対する指摘事項

レビューの結果、以下6領域で重大な課題が特定された。

### 指摘1: 2回LLM推論のコスト未検証（アーキテクチャ）

20Bモデルのローカル推論を2回（統合＋生成）行う設計だが、合計レイテンシの実用性が未検証。フェーズ2の「統合・ノイズ除去」をLLMにやらせる必然性に疑問が呈された。

### 指摘2: セキュリティ設計の全面的欠如

プロンプトインジェクション対策、内部文書の漏洩防止、入力バリデーションがいずれも未記載であり、仕様書最大の欠落と評価された。

### 指摘3: 「内部情報＝絶対正解」という前提の危険性

競合解決で内部情報をグラウンドトゥルースとして一律優先する設計は、内部文書が古い・誤っている場合に対応できない。また、プロンプト指示だけで20Bモデルがルールを遵守する保証もない。

### 指摘4: トークン管理の粗さ

「文字数によるTrimming」はトークン数と乖離する（特に日本語）。トークンバジェットの内訳も未定義。

### 指摘5: 評価・観測可能性の欠如

回答品質の評価方法、ログ取得方針、障害時のフォールバックがいずれも未定義。

### 指摘6: その他の未定義事項

埋め込みモデル、チャンク分割戦略、マルチターン対応が未記載。

---

## 3. 意思決定フェーズ: 方針転換の議論

### 決定事項1: システムの用途を明確化

**オーナーの発言要旨:**
> ローカルで実行する情報収集と意思決定のアシスタントであり、その用途限定を前提にどこまで改善すべきか再設計して

**決定:** システムのスコープを「ローカル実行の意思決定支援ツール」に明確に限定する。不特定多数向けサービスではないことを前提とし、セキュリティや非機能要件はこのスコープに応じて適正化する。

### 決定事項2: 内部文書の位置づけを根本的に再定義

**オーナーの発言要旨:**
> 内部情報が必ずしも正しくない、というのは的確な指摘。どちらかというと、これまでの意思決定や改善のログが多く、正確な情報は期待していないが、文脈や文化は非常に重視する

**決定:** 内部文書を「正確な事実情報（グラウンドトゥルース）」ではなく「組織の意思決定履歴・文脈・文化の体現」として再定義する。これはシステム全体の設計思想に影響する根本的な方針転換であり、競合解決ロジック、プロンプト設計、評価基準のすべてに波及する。

---

## 4. 再設計フェーズ: v2で反映された主要な設計判断

上記の方針転換を受け、以下の設計判断を行い再設計仕様書v2に反映した。

### 判断1: 競合解決ロジックの再構築

| | v1 | v2 |
|---|---|---|
| 原則 | 内部情報を一律で正解として優先 | 情報の性質により分岐 |
| 事実データの矛盾 | 内部優先 | **外部Web情報を優先**し、内部との差異を注記 |
| 方針・判断基準の矛盾 | 内部優先 | **内部の文脈を尊重**しつつ、更新の必要性があれば提示 |

**根拠:** 内部文書は意思決定ログであり事実の正確性は保証されない。一方で、組織がなぜその判断に至ったかの文脈は極めて重要。この二面性を反映した分岐ロジックとした。

### 判断2: LLM呼び出し回数の削減（2回→1回）

**採用案:** フェーズ2（統合・ノイズ除去）をリランカー（cross-encoder）＋ルールベースの前処理に置き換え、LLM呼び出しを1回に削減。

**根拠:** 20Bモデルのローカル推論は1回あたり数秒〜数十秒。2回呼び出しはUX上許容困難。統合・フィルタリングは軽量モデルで十分代替可能。

**不採用案:** 小型モデル（7B等）をフェーズ2に使う案も検討し得たが、推論サーバーの複雑化を避けるため見送り。

### 判断3: セキュリティのスコープ適正化

**決定:** ローカル利用・限定ユーザー前提のため、WAF・レートリミット・RBAC等は不要と明示的に除外。対処すべき脅威を以下の2つに絞った。

1. Web検索結果経由の間接的プロンプトインジェクション → デリミタタグ＋運用（人間が最終判断）で対処
2. 内部文書の外部漏洩 → 設計上の通信経路を限定し、コードレビューで検証

**根拠:** 20Bモデルに対する完全なプロンプトインジェクション防御は技術的に非現実的。「意思決定の支援であり最終判断は人間」という運用前提が最大のセーフティネットとなる。

### 判断4: 内部文書のライフサイクル管理の導入

**決定:** 意思決定ログは時間経過で陳腐化するため、`status`（active / superseded / archived）によるライフサイクル管理を導入。12ヶ月超のactive文書には自動アラートを設定。

**根拠:** オーナーが内部文書の正確性を期待していないという発言から、「古い判断」と「現行の判断」を区別する仕組みが不可欠と判断。

### 判断5: トークンバジェットの配分方針

**決定:** 内部文書に3000トークン、外部Webに2000トークンを配分。超過時は外部情報を先に削減。

**根拠:** 本システムの差別化要因は内部文脈の活用にある。Web情報は補助的な事実供給源であり、バジェット逼迫時に先に犠牲にすべきと判断。

---

## 5. 残課題（今後の検討事項）

| 課題 | 備考 |
|---|---|
| マルチターン対話 | v2ではシングルターンQ&Aをスコープとし、Phase 3以降で検討 |
| プロンプトの実機検証 | gpt-oss-20bでの競合解決ルール遵守率は未検証。MVP後にベンチマーク必要 |
| 埋め込みモデルの比較評価 | multilingual-e5-largeを仮選定したが、内部文書（日本語の意思決定ログ）での検索精度は要検証 |
| フィードバックループの有効性 | 3段階フィードバック（有用/不十分/誤り）が改善に十分な粒度かは運用後に判断 |

---

## 6. 合意事項まとめ

1. システムのスコープは「ローカル実行の意思決定支援ツール」に限定する
2. 内部文書は「正解」ではなく「文脈・文化」として扱い、事実の正確性はWeb情報に委ねる
3. LLM呼び出しは1回に削減し、前処理はリランカーで代替する
4. セキュリティは脅威モデルに基づきスコープし、過剰な対策は行わない
5. 観測可能性（ログ・フィードバック・月次評価）を初期から組み込む
6. 実装はMVP→品質改善→運用サイクルの3フェーズで進める
