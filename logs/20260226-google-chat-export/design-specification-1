# Google Chat ログ抽出システム 設計仕様書

本ドキュメントは、Google Chatの会話ログを外部出力するための2種類のシステムに関する技術設計仕様を定義する。

---

## 1. 特定ユーザーのチャットログ抽出システム

### 1.1. システムの目的
指定した特定ユーザー（例: `user@example.com`）がGoogle Chat上（すべてのスペースおよびDM）で行った1日分の発言を横断的に抽出し、テキストデータとして外部保存する。

### 1.2. システム構成
* **実行環境:** Google Cloud Functions (Python 3.x) または Google Apps Script (GAS)
* **主要API:** Google Vault API (`matters.exports.create`, `matters.exports.get`)
* **実行トリガー:** 日次バッチ処理（毎日 深夜帯に実行）
* **出力先:** Google Cloud Storage (GCS) または Google Drive

### 1.3. 処理フロー
1. **検索条件の生成:** 実行日の前日を対象期間とし、対象ユーザーのメールアドレスを条件（`from:user@example.com`）として検索クエリを生成する。
2. **エクスポートジョブの作成:** Vault APIを呼び出し、生成したクエリを用いてデータのエクスポート処理（抽出タスク）をリクエストする。
3. **ステータス監視 (ポーリング):** Vaultの抽出は非同期で行われるため、一定間隔でAPIを呼び出し、ジョブステータスが `COMPLETED` になるのを待機する。
4. **データのダウンロード:** 完了後、発行されたダウンロードURLから抽出データ（MBOX形式またはXML形式）を取得する。
5. **データパース・整形:** ダウンロードした監査用データファイルから、「タイムスタンプ」と「発言テキスト」を正規表現等を用いて抽出し、時系列順のプレーンテキストに整形する。
6. **ファイル保存:** `YYYYMMDD_{ユーザー名}_chatlog.txt` のようなファイル名で、指定のストレージに保存する。

### 1.4. 前提条件・制約事項
* **権限:** 実行環境に紐づくサービスアカウントに対し、Google Workspaceの「Vault管理者」または「特権管理者」の権限付与が必須となる。
* **データ形式の複雑さ:** Vaultからエクスポートされるデータは監査用の複雑なフォーマットであるため、パース（テキスト抽出）処理の実装・メンテナンスコストが比較的高い。
